ARG           BUILDER_BASE=docker.io/dubodubonduponey/debian@sha256:04f7bfea58c6c4af846af6d34fc25d6420c50d7ae8e0ca26e6bf89779437feb0

#######################
# Downloader is here only to retrieve and validate upstream tarballs
#######################
# hadolint ignore=DL3006
FROM          $BUILDER_BASE                                                                                             AS downloader-builder

ARG           BUILD_CREATED="1976-04-14T17:00:00-07:00"

ARG           DEBIAN_FRONTEND="noninteractive"
ENV           TERM="xterm"
ENV           LANG="C.UTF-8"
ENV           LC_ALL="C.UTF-8"
ENV           TZ="America/Los_Angeles"

ENV           NODE_VERSION=10.23.0
ENV           YARN_VERSION=1.22.5

ENV           GOLANG_VERSION=1.15.6
ENV           GOLANG_LINUX_AMD64_SHA512=007487ca71c1b7874a5e9d0e2125c3b05b98321ff6997547ab4105d3b2d0fad04a1ffaeac94549a2605972bc3c2bbbfc8fb9b428f3732f98ccbe3b388dbb258d
ENV           GOLANG_LINUX_ARM64_SHA512=2d2b14d880c929ff8e1438f738e7cb0be091f76b388e23e7742d677f1d20a47ce6ffdfac0437529c9f8cf896e79c2f35c5b174c31e7456beea76d8fb6cd0e901
ENV           GOLANG_LINUX_ARM_V7_SHA512=f0a411079c68d4213cc644e9099cae07fcd517d99da8acc95cfb57cbedaa68203a0e8f5072133dbb7c78f5b16e16ddfcffafb068d198c60c5d25385ea5efa619
ENV           GOLANG_LINUX_ARM_V6_SHA512=f0a411079c68d4213cc644e9099cae07fcd517d99da8acc95cfb57cbedaa68203a0e8f5072133dbb7c78f5b16e16ddfcffafb068d198c60c5d25385ea5efa619
ENV           GOLANG_LINUX_386_SHA512=9d4c1338b33db79add484abf2f3bff6ab4bbc9b0dde9355f0468a4d7b9a9d7c7f735e191de19b0974444c8d3ed58568ec4a763c3834e4da66cd5eb5b8fea3159
ENV           GOLANG_LINUX_S390X_SHA512=55b66124bf1345197b41d0a772163916bcfeab7f1a04f70d65d80ad1825147f840f79e515e99a4c4c2e574bcb25c06cb7500c85dfe8570545810b856725cefe3
ENV           GOLANG_LINUX_PPC64LE_SHA512=bf365a45ea16930ae18919d17aa7152607c851ed04130bde3b4987681efe9f1cf2ebc1b111f55ff689024df37891dfb7e3299f724f653a576047af861cf9bf7d

ENV           FAIL_WHEN_OUTDATED=true

# hadolint ignore=DL3009
RUN           set -eu; \
              apt-get update -qq && \
              apt-get install -qq --no-install-recommends \
                curl=7.64.0-4+deb10u1 \
                gnupg=2.2.12-1+deb10u1 \
                dirmngr=2.2.12-1+deb10u1 \
                ca-certificates=20200601~deb10u1

RUN           update-ca-certificates

COPY          ./scripts /scripts

COPY          ./cache /cache

RUN           /scripts/entrypoint.sh

RUN           epoch="$(date --date "$BUILD_CREATED" +%s)"; \
              find /cache -newermt "@$epoch" -exec touch --no-dereference --date="@$epoch" '{}' +

FROM          scratch                                                                                                   AS downloader

COPY          --from=downloader-builder /cache /cache
