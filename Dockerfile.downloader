ARG           FROM_REGISTRY=docker.io/dubodubonduponey
ARG           FROM_IMAGE_BUILDER=debian:bullseye-2022-09-01

#######################
# Downloader is here only to retrieve and validate upstream tarballs
#######################
FROM          $FROM_REGISTRY/$FROM_IMAGE_BUILDER                                                                        AS downloader-builder

ARG           BUILD_CREATED="1976-04-14T17:00:00-07:00"

ENV           NODE_VERSION=16.17.0
ENV           YARN_VERSION=1.22.5

#ENV           GOLANG_VERSION 1.17.13
#ENV           GOLANG_LINUX_AMD64_SHA512 672ce66bd7f1400b66d367f1026f3d7062201a8d686b4c1813ccade597ebbe89f9bd98130badd1d7bc6f2cf4020d63a4e71323b44a96fad842d5766ca92aa822
#ENV           GOLANG_LINUX_ARM64_SHA512 8f70e89f7dbffe0d4892460a7508b8acd5830999150732388bf69a49e2120cadabe3b4ce641cfe805d4bf871d6e374ad2398fb029f55361607e0eba1c7ea62a4
#ENV           GOLANG_LINUX_ARM_V7_SHA512 5fb56d05e0fe31a4253c4972e158c3c643af387795db68861445822cea24a657a35ddb8d9f0aacd7624d7f6f9d8f7d721b6df9be9862eab3c851cc30751e7f46
#ENV           GOLANG_LINUX_ARM_V6_SHA512 5fb56d05e0fe31a4253c4972e158c3c643af387795db68861445822cea24a657a35ddb8d9f0aacd7624d7f6f9d8f7d721b6df9be9862eab3c851cc30751e7f46
#ENV           GOLANG_LINUX_386_SHA512 0449a2b27d75d654fd214776ae3025d098f55d93a7b0ce07325864f1637d7ae4c8eca782578b6edbd05536e031339ee2bb466f82cbe5d29506033ea9f1aed167
#ENV           GOLANG_LINUX_S390X_SHA512 7f9b5e42dc1ac2993a8acab3ed625b0190c6c6300231c520852fb56ceb7f828ea9e1dbefca4230ec2aa290b36b61db48f764d4eafe39b79f2f570c4c62f6bb50
#ENV           GOLANG_LINUX_PPC64LE_SHA512 f259e4304afa85ce638c3c238cddce0dc6a78c2024e715a35c09ba6d0e71e6c4dd24937b84038f76c299aaa1f95be13d7d77513c5dfcb583ed87d4bdeec2114a

ENV           GOLANG_VERSION 1.18.6
ENV           GOLANG_LINUX_AMD64_SHA512 d71abdf8a3639207185b373697888ec5a95b282ac798ce1a112ac6edcd41c3f331609560b6915336b316018b22e8fff4df1a3cb12d075bbc5492c869013f7f59
ENV           GOLANG_LINUX_ARM64_SHA512 b2a27866697af6639db730fa1784510df31461daddac70197aa28964bc5babd5c9c70306e76b5a578aa742fa128bd985cf3b6d929aded12774474d109973fa07
ENV           GOLANG_LINUX_ARM_V7_SHA512 9506cba86c48f6b35cc2db25343df99a24324e58dd96cbcd4115f72d5fbfe44e888722d8d7fd2f4ba5750227ccf70a9c8afdc14ed9030efefbec1dfd45897d88
ENV           GOLANG_LINUX_ARM_V6_SHA512 9506cba86c48f6b35cc2db25343df99a24324e58dd96cbcd4115f72d5fbfe44e888722d8d7fd2f4ba5750227ccf70a9c8afdc14ed9030efefbec1dfd45897d88
ENV           GOLANG_LINUX_386_SHA512 8e494196d9530a8244d452d012b51b511c5c142b41a4d0bbcbf5350cb0cfe008b3d7ac1a4374fb56888fe5531d1868870be2aa10646062c5c0c4b8ae2b24f314
ENV           GOLANG_LINUX_S390X_SHA512 9bfbe53e97ee2df417d3056a98ea0a6b7604ca53fe0119351580533a826e1f913d4cfb2926ee7c6b66c4fba9cb1bb13b3b8ad75b40585975e42e334405f6bea4
ENV           GOLANG_LINUX_PPC64LE_SHA512 39669a0d878020e94452ae8dab43be679833416cdf83618030897cf06cfeb3e23123a02419ea1d47e019c0ffb285a888adf404332d9026946fc5d5322af7e445

#14 3.760 ENV           GOLANG_VERSION 1.19.1
#14 5.791 ENV           GOLANG_LINUX_AMD64_SHA512 a69153393a2eaf1c2b77f5a4bafe6a2fb36368c6856d79bd697472af71d925fc62c58e6b8fe75adf143b0462da2ed9e68d0fcd0328cde091be70d745b92814aa
#14 7.555 ENV           GOLANG_LINUX_ARM64_SHA512 c7ad05c39e2890b57a6ba05521347c58fa5fd325d8f1aa3058da4ccf0ea7e9ea910fddae1789f24f48b39188ce8ff025d31778c79c977040785c6a641dde8ee3
#14 9.211 ENV           GOLANG_LINUX_ARM_V7_SHA512 8747e9473495622f93ec735557eaaac3200817406b2f087bd46989df576806900314a5352443f16a686b2b5fcd8fc313403decbed04c2eca6cd89a80786ea644
#14 10.77 ENV           GOLANG_LINUX_ARM_V6_SHA512 8747e9473495622f93ec735557eaaac3200817406b2f087bd46989df576806900314a5352443f16a686b2b5fcd8fc313403decbed04c2eca6cd89a80786ea644

ENV           FAIL_WHEN_OUTDATED=true

# hadolint ignore=DL3009
RUN           --mount=type=secret,uid=100,id=CA \
              --mount=type=secret,uid=100,id=CERTIFICATE \
              --mount=type=secret,uid=100,id=KEY \
              --mount=type=secret,uid=100,id=GPG.gpg \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=APT_SOURCES \
              --mount=type=secret,id=APT_CONFIG \
              apt-get update -qq; \
              apt-get install -qq --no-install-recommends \
                curl=7.74.0-1.3+deb11u2 \
                gnupg=2.2.27-2+deb11u2 \
                dirmngr=2.2.27-2+deb11u2 \
                ca-certificates=20210119

COPY          ./scripts /scripts

COPY          ./cache /cache

# Helper for our secrets
ENV           CURL_HOME=/run/secrets

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh node

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh yarn

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh golang

RUN           epoch="$(date --date "$BUILD_CREATED" +%s)"; \
              find /cache -newermt "@$epoch" -exec touch --no-dereference --date="@$epoch" '{}' +

FROM          scratch                                                                                                   AS downloader

COPY          --from=downloader-builder /cache /cache
