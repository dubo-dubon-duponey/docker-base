ARG           FROM_REGISTRY=ghcr.io/dubo-dubon-duponey
ARG           FROM_IMAGE_BUILDER=debian:bullseye-2021-09-15@sha256:a0cf7d86e967172d1bdddbb472d63329af880765ed212915d57930b3379efbc4

#######################
# Downloader is here only to retrieve and validate upstream tarballs
#######################
FROM          $FROM_REGISTRY/$FROM_IMAGE_BUILDER                                                                        AS downloader-builder

ARG           BUILD_CREATED="1976-04-14T17:00:00-07:00"

ENV           NODE_VERSION=14.17.6
ENV           YARN_VERSION=1.22.5

ENV           GOLANG_VERSION 1.16.8
ENV           GOLANG_LINUX_AMD64_SHA512 ce6683bcafb5f0a980dcf1099202f00849ace729381eb3c10b77465f3e26f511990ab4ada7116231aa4ca51f004c3385991a982b5f8003f198fe5819868ed5b7
ENV           GOLANG_LINUX_ARM64_SHA512 5b35aa242ad725fca6d6e5a60eb41532cd27319fe8acd728d14e51528009fd6245f0e33a12a3fb778102d647db606fa67b5cb55623f42825f6b6977b0dbd8422
ENV           GOLANG_LINUX_ARM_V7_SHA512 9c8d5cff0d909880a7d3a82c16da36bd9d1287a35c5737d6bff3449e6b093420a405c0bfeb55c882df12b6315ef6fd274a22cda22cc5ca380c59b7e7e10db0e8
ENV           GOLANG_LINUX_ARM_V6_SHA512 9c8d5cff0d909880a7d3a82c16da36bd9d1287a35c5737d6bff3449e6b093420a405c0bfeb55c882df12b6315ef6fd274a22cda22cc5ca380c59b7e7e10db0e8
ENV           GOLANG_LINUX_386_SHA512 143fd36c89485b93c5c242f8b4cc300d545046bbaa84457672bb64085f6e53a43cb1cc8152f342c3c3dbd12e459a43382e9bf3817fa5424e68ec00e8150a4f09
ENV           GOLANG_LINUX_S390X_SHA512 021acdcc2cdeac9dd999f88e6515e79891d3d01229fc77ef8492de83589db5ca7d0379a5f3d59bc43dd3fe938951f7ee0972091d919caa4ff8c23018b0b7b3dd
ENV           GOLANG_LINUX_PPC64LE_SHA512 e56ce2c98a0a4b5093de543a09849f835107906d8f151f30955365ea1b3dda1cbf007fb28d048299c745300bc4f085ac91182e44472601432a525ee955af6675

#ENV           GOLANG_OLD_VERSION 1.15.13
#ENV           GOLANG_OLD_LINUX_AMD64_SHA512 866aa22f9ecdba3c250f206d71ced5857aee67bf8da470b68447c11488dc80e243e985c9baeedf56476ddc113320bf0ed5efe8453bd3da071c4aa3abb58e142d
#ENV           GOLANG_OLD_LINUX_ARM64_SHA512 362499cd4640bd7a9a7358afbcdd89783c0af5ac2a2209a37e8f15dc2e1392fa1d4704ec33cdf28fa00c09a13b36568e639634b8fa89b958ee7fa9237f1f3e93
#ENV           GOLANG_OLD_LINUX_ARM_V7_SHA512 26eff19aeef922554f6582767488182bf16e3278e0c124f6d0c6524db441465b6c1432976c4c6e88b84a2aab385280e1dd374428c2ac0070806593e108f2ad54
#ENV           GOLANG_OLD_LINUX_ARM_V6_SHA512 26eff19aeef922554f6582767488182bf16e3278e0c124f6d0c6524db441465b6c1432976c4c6e88b84a2aab385280e1dd374428c2ac0070806593e108f2ad54
#ENV           GOLANG_OLD_LINUX_386_SHA512 6c92732fb2ce75b084cb925e9813d45d626cae8193a1fa4a8f057e65bef1ff6bb64ac68d417dedae51ebae1182b54fb9365ac82dcc42751b2fc697aad015625a
#ENV           GOLANG_OLD_LINUX_S390X_SHA512 0739486667d6a9ea9514dce309afb28a38505ae49337fc3223dcff038685858afbe1f507b6d4d4b89872874e01d01ceac7f0f814f439fbdf4734a212188ee4c9
#ENV           GOLANG_OLD_LINUX_PPC64LE_SHA512 c8a7de65d4f633ee7c058070c6ebd01c3ebcfc9119e2371d18bb775b72b1961c705579df59c69c781eba29b0bbec901080c296ea568a12b610f70c65e2109cf4

ENV           FAIL_WHEN_OUTDATED=true

# hadolint ignore=DL3009
RUN           --mount=type=secret,uid=100,id=CA \
              --mount=type=secret,uid=100,id=CERTIFICATE \
              --mount=type=secret,uid=100,id=KEY \
              --mount=type=secret,uid=100,id=GPG.gpg \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=APT_SOURCES \
              --mount=type=secret,id=APT_CONFIG \
              apt-get update -qq; \
              apt-cache show curl gnupg dirmngr ca-certificates; \
              apt-get install -qq --no-install-recommends \
                curl=7.74.0-1.3+b1 \
                gnupg=2.2.27-2 \
                dirmngr=2.2.27-2 \
                ca-certificates=20210119

COPY          ./scripts /scripts

COPY          ./cache /cache

# Helper for our secrets
ENV           CURL_HOME=/run/secrets

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh node

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh yarn

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh golang

RUN           epoch="$(date --date "$BUILD_CREATED" +%s)"; \
              find /cache -newermt "@$epoch" -exec touch --no-dereference --date="@$epoch" '{}' +

FROM          scratch                                                                                                   AS downloader

COPY          --from=downloader-builder /cache /cache
