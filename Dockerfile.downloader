ARG           FROM_REGISTRY=docker.io/dubodubonduponey
ARG           FROM_IMAGE_BUILDER=debian:bookworm-2023-09-08

#######################
# Downloader is here only to retrieve and validate upstream tarballs
#######################
FROM          $FROM_REGISTRY/$FROM_IMAGE_BUILDER                                                                        AS downloader-builder

ARG           BUILD_CREATED="1976-04-14T17:00:00-07:00"

ENV           NODE_VERSION=16.20.2
ENV           YARN_VERSION=1.22.5

#ENV           GOLANG_VERSION 1.17.13
#ENV           GOLANG_LINUX_AMD64_SHA512 672ce66bd7f1400b66d367f1026f3d7062201a8d686b4c1813ccade597ebbe89f9bd98130badd1d7bc6f2cf4020d63a4e71323b44a96fad842d5766ca92aa822
#ENV           GOLANG_LINUX_ARM64_SHA512 8f70e89f7dbffe0d4892460a7508b8acd5830999150732388bf69a49e2120cadabe3b4ce641cfe805d4bf871d6e374ad2398fb029f55361607e0eba1c7ea62a4
#ENV           GOLANG_LINUX_ARM_V7_SHA512 5fb56d05e0fe31a4253c4972e158c3c643af387795db68861445822cea24a657a35ddb8d9f0aacd7624d7f6f9d8f7d721b6df9be9862eab3c851cc30751e7f46
#ENV           GOLANG_LINUX_ARM_V6_SHA512 5fb56d05e0fe31a4253c4972e158c3c643af387795db68861445822cea24a657a35ddb8d9f0aacd7624d7f6f9d8f7d721b6df9be9862eab3c851cc30751e7f46
#ENV           GOLANG_LINUX_386_SHA512 0449a2b27d75d654fd214776ae3025d098f55d93a7b0ce07325864f1637d7ae4c8eca782578b6edbd05536e031339ee2bb466f82cbe5d29506033ea9f1aed167
#ENV           GOLANG_LINUX_S390X_SHA512 7f9b5e42dc1ac2993a8acab3ed625b0190c6c6300231c520852fb56ceb7f828ea9e1dbefca4230ec2aa290b36b61db48f764d4eafe39b79f2f570c4c62f6bb50
#ENV           GOLANG_LINUX_PPC64LE_SHA512 f259e4304afa85ce638c3c238cddce0dc6a78c2024e715a35c09ba6d0e71e6c4dd24937b84038f76c299aaa1f95be13d7d77513c5dfcb583ed87d4bdeec2114a

#ENV           GOLANG_VERSION 1.18.10
#ENV           GOLANG_LINUX_AMD64_SHA512 2f1986ae1a95f1e2e735abdf2240770210482215c03293322ce9d3cb7b5c7b2904943827154d048771b00fa95d9b5e659d8077873dea0352d7d8cca8880ce204
#ENV           GOLANG_LINUX_ARM64_SHA512 a488de01c7eefa02833d153c79ffed5fd126b6d84418c285fd4577f6dfa235a648eb3bbd160eb53d187db512a13015f9bb9310a32ef2b2141d869155c282b3df

#ENV           GOLANG_LINUX_ARM_V7_SHA512 c0c2dd514cd7eaba67c6236543ba2399b8f85ab0828cc2b62dff4936d1266339a643f7606c2b914cd8cf93360a500865ae18f42c87140f2c201cc7136f032337
#ENV           GOLANG_LINUX_ARM_V6_SHA512 c0c2dd514cd7eaba67c6236543ba2399b8f85ab0828cc2b62dff4936d1266339a643f7606c2b914cd8cf93360a500865ae18f42c87140f2c201cc7136f032337
#ENV           GOLANG_LINUX_386_SHA512 7ad352c874bdc931dea7bd99a34762f5d96bfd63e08cb4ff74a2db19c4ad0cb3bced57c97f683a6bd9a737aaee0ffe1d74f39b0cf81897b89e8dae1187acb634
#ENV           GOLANG_LINUX_S390X_SHA512 1919eda41493a86d6e70ccd98102d767a68621363c2d178fb329e4fedc5de0094acf2e19fa56cb4e288085bdef1cf932cf836a609837e10f50384e716e899c2f
#ENV           GOLANG_LINUX_PPC64LE_SHA512 4017fe35e57af3354f8576ac9b450da7df54773979d2de74baf6ea61375d196ffa84c17074e53ea63510cc75b3401d6c71d51b5b3eafb9aee7828fafa1d7b9cb

#14 3.760 ENV           GOLANG_VERSION 1.19.1
#14 5.791 ENV           GOLANG_LINUX_AMD64_SHA512 a69153393a2eaf1c2b77f5a4bafe6a2fb36368c6856d79bd697472af71d925fc62c58e6b8fe75adf143b0462da2ed9e68d0fcd0328cde091be70d745b92814aa
#14 7.555 ENV           GOLANG_LINUX_ARM64_SHA512 c7ad05c39e2890b57a6ba05521347c58fa5fd325d8f1aa3058da4ccf0ea7e9ea910fddae1789f24f48b39188ce8ff025d31778c79c977040785c6a641dde8ee3
#14 9.211 ENV           GOLANG_LINUX_ARM_V7_SHA512 8747e9473495622f93ec735557eaaac3200817406b2f087bd46989df576806900314a5352443f16a686b2b5fcd8fc313403decbed04c2eca6cd89a80786ea644
#14 10.77 ENV           GOLANG_LINUX_ARM_V6_SHA512 8747e9473495622f93ec735557eaaac3200817406b2f087bd46989df576806900314a5352443f16a686b2b5fcd8fc313403decbed04c2eca6cd89a80786ea644

ENV           GOLANG_VERSION 1.20.8
ENV           GOLANG_LINUX_AMD64_SHA512 25fca289e35b09120935389e56733b3f6e849a98f819228708e6ca6202df0f07542dfc82b8447d959e9a2fc1fee27742f4ab397229c6cb883d7a2280e6176f38
ENV           GOLANG_LINUX_ARM64_SHA512 d77c5139c49c644389876f64ebc58ae2f0eb87e5eca7d98edbb948160e78e2930a340ad350ed53738037f25f6986fd70ffb49097984ec26a8991ef5881b35c4a
ENV           GOLANG_LINUX_ARM_V7_SHA512 bc30043d5d781891bb08af9d8fcd32a6279cd654fb287a21cb4d57086dafc46ebae78486826ffe0d94b8aa974bd0004408c93f4530288b7c3267bc7950ef52c1

ENV           FAIL_WHEN_OUTDATED=true

# hadolint ignore=DL3009
RUN           --mount=type=secret,uid=100,id=CA \
              --mount=type=secret,uid=100,id=CERTIFICATE \
              --mount=type=secret,uid=100,id=KEY \
              --mount=type=secret,uid=100,id=GPG.gpg \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=APT_SOURCES \
              --mount=type=secret,id=APT_CONFIG \
              apt-get update -qq; \
              apt-get install -y --no-install-recommends \
                curl=7.88.1-10+deb12u1 \
                gnupg=2.2.40-1.1 \
                dirmngr=2.2.40-1.1 \
                ca-certificates=20230311

COPY          ./scripts /scripts

COPY          ./cache /cache

# Helper for our secrets
ENV           CURL_HOME=/run/secrets

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh node

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh yarn

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh golang

RUN           epoch="$(date --date "$BUILD_CREATED" +%s)"; \
              find /cache -newermt "@$epoch" -exec touch --no-dereference --date="@$epoch" '{}' +

FROM          scratch                                                                                                   AS downloader

COPY          --from=downloader-builder /cache /cache
