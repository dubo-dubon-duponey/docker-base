ARG           BUILDER_BASE=docker.io/dubodubonduponey/debian@sha256:04f7bfea58c6c4af846af6d34fc25d6420c50d7ae8e0ca26e6bf89779437feb0

#######################
# Downloader is here only to retrieve and validate upstream tarballs
#######################
# hadolint ignore=DL3006
FROM          $BUILDER_BASE                                                                                             AS downloader-builder

ARG           BUILD_CREATED="1976-04-14T17:00:00-07:00"

ARG           DEBIAN_FRONTEND="noninteractive"
ENV           TERM="xterm"
ENV           LANG="C.UTF-8"
ENV           LC_ALL="C.UTF-8"
ENV           TZ="America/Los_Angeles"

ENV           NODE_VERSION 10.23.0
ENV           YARN_VERSION 1.22.5

ENV           GOLANG_VERSION 1.15.4
ENV           GOLANG_LINUX_AMD64_SHA512 31ce7e77c123c89b9eff18569d91cf62cbcb00b53ef0b4342e52578a25b405c8aaae13ce4d62e994e5c8d5235b471168091dc5a62f5bb153589b5c8aa8f1b952
ENV           GOLANG_LINUX_ARM64_SHA512 dda95e9b9ffdb22f7416696ee73cedf1aee8eeecdb000e811ef2497483761adb627ea1371a0edbd651e4c90649b6e0d7606e931baf1a80cbecc93931aa70f544
ENV           GOLANG_LINUX_ARM_V7_SHA512 c8f718aed22624e66497c3145a7f6d5cc88b8e10ccc4a4976b22efef691853ce196bcfc107c1cbefe299634ba95c35018eaa65406227e9eb8bee0a99c01af121
ENV           GOLANG_LINUX_ARM_V6_SHA512 c8f718aed22624e66497c3145a7f6d5cc88b8e10ccc4a4976b22efef691853ce196bcfc107c1cbefe299634ba95c35018eaa65406227e9eb8bee0a99c01af121
ENV           GOLANG_LINUX_386_SHA512 14782e9e4c383f7f7b1068bbdf874485b24e5313d77099ea745c2556adc33aaf5613eeb34c5aef309c38e0c54dc253cb5493f4a9283e804111214cf5528f5949
ENV           GOLANG_LINUX_S390X_SHA512 78d8b428af4b33253db46a4af4c28027319fb681b794b4337238ddaaa5ec438675ef7ef6c426adb274e8fea2b4331af0aa7bf023d4d24865079c033e9be14a8b
ENV           GOLANG_LINUX_PPC64LE_SHA512 fd174b5a1e0a1cfe2bbaf0607ce49b67d3a945933b9845217063121a1e253212d85076e3fe9616bd97efb00836a2c23ab61e43ad75e5cf76cee434b036b896e6

ENV           FAIL_WHEN_OUTDATED true

# hadolint ignore=DL3009
RUN           set -eu; \
              apt-get update -qq && \
              apt-get install -qq --no-install-recommends \
                curl=7.64.0-4+deb10u1 \
                gnupg=2.2.12-1+deb10u1 \
                dirmngr=2.2.12-1+deb10u1 \
                ca-certificates=20200601~deb10u1

RUN           update-ca-certificates

COPY          ./scripts /scripts

COPY          ./cache /cache

RUN           /scripts/entrypoint.sh

RUN           epoch="$(date --date "$BUILD_CREATED" +%s)"; \
              find /cache -newermt "@$epoch" -exec touch --no-dereference --date="@$epoch" '{}' +

FROM          scratch                                                                                                   AS downloader

COPY          --from=downloader-builder /cache /cache
