ARG           FROM_REGISTRY=ghcr.io/dubo-dubon-duponey
ARG           FROM_IMAGE_BUILDER=debian:bullseye-2022-06-01@sha256:0f4f51555f4c320809bf842095d703c0c9918127eb33a5cc1a34ebea304bb4d6

#######################
# Downloader is here only to retrieve and validate upstream tarballs
#######################
FROM          $FROM_REGISTRY/$FROM_IMAGE_BUILDER                                                                        AS downloader-builder

ARG           BUILD_CREATED="1976-04-14T17:00:00-07:00"

ENV           NODE_VERSION=16.15.1
ENV           YARN_VERSION=1.22.5

#ENV           GOLANG_VERSION 1.16.15
#ENV           GOLANG_LINUX_AMD64_SHA512 4b034e9ded3b2f67e271d07185e697854f4c22018f26312b9118443331b585f0576c2655de899e7c66082218bc00810ba52f7f45832103e7da9320056b4d6e47
#ENV           GOLANG_LINUX_ARM64_SHA512 96f5a1f0897fdc5fa3e7e69ac4cc111cc5d0683f82b2338c3aec58b59e8fa882e1a6c3debff01e53cb542d068f16ab7ba626e04bde5171a5d3c1d6cc2285f5bf
#ENV           GOLANG_LINUX_ARM_V7_SHA512 326f4763e4fc8c5237c181d4d7a2f505a7526adc7f5ffdde6e11774ec297a60d8a92e7f726365b3b8d5b9b1fb6cca6a693c310a806e6327da719ea037b464eed
#ENV           GOLANG_LINUX_ARM_V6_SHA512 326f4763e4fc8c5237c181d4d7a2f505a7526adc7f5ffdde6e11774ec297a60d8a92e7f726365b3b8d5b9b1fb6cca6a693c310a806e6327da719ea037b464eed
#ENV           GOLANG_LINUX_386_SHA512 d55d44df79f99a35f1544bb50c2d97bb7fc6eea894bfef68073a98d43f989cc09f6ccadac1da90f7130954d10b8533fe355fa5ee301c9110cb5225730e0c0b71
#ENV           GOLANG_LINUX_S390X_SHA512 453e27ef9b3a84a9dd8e30e287971c338952e889c2463fcc32275c86c7bcbb569cf1fad9652c3aded2e88eaf23fcd38149592b4627adefb4e9967a0cebb05c04
#ENV           GOLANG_LINUX_PPC64LE_SHA512 858009ec3e9800975c6a0eb144e1af256470f397b820273ab4bcfaa44d7dc32bd1ae9ba37ec3c653585bf4e5f206f07b08765bddcf09cf70197d55bdef0c1676

#ENV           GOLANG_VERSION 1.17.8
#ENV           GOLANG_LINUX_AMD64_SHA512 f7dd9bd8bb4ddbf6906a8538f007b099d26a51ef13ccd8a3077945585e800d60e476934316a6a2335dcc25a425e641b73f96b00323c5468aa0bb938b5b6987d7
#ENV           GOLANG_LINUX_ARM64_SHA512 58dac7340ed34ba81e675dd906c3512cf061c06cc7526fcc1724a9836452d557b3fe59da62e91cd41e9284f410f41b077f6375ffc7115393467f96067822893f
#ENV           GOLANG_LINUX_ARM_V7_SHA512 778e618ad571436205d0855fddd8d21a59402af5ea60ed6b44be652d0cdde7e51fa89053dfb83cdc7c34de046f6728813da428fea5970a9a62efbe6a00b820c0
#ENV           GOLANG_LINUX_ARM_V6_SHA512 778e618ad571436205d0855fddd8d21a59402af5ea60ed6b44be652d0cdde7e51fa89053dfb83cdc7c34de046f6728813da428fea5970a9a62efbe6a00b820c0
#ENV           GOLANG_LINUX_386_SHA512 737c4c5a4eedcfe9cc29a1e133f79b46ad0326ee6a295aeab7e7569186f3854f5873aed23ebcc1b490f4bec66aa65ccc7ebcc8b768622fd557b348cda45c0cc4
#ENV           GOLANG_LINUX_S390X_SHA512 f8923d3fbbc5cc62fd661660615bb91a8128d1bbd176a4826c3bcf50565df4f8636017a58f74f5894370b03f4a61bdcc4827f9a8c3576b832c228ddba4782867
#ENV           GOLANG_LINUX_PPC64LE_SHA512 9086ac089761e03586245183bacb3432ed7c6c9635c457c8f1a03a2cd3efeecaa7c5e952ca90a00d0e1a8fd720a0e980c79ceac1ec21ecb21aa3fe9a4b24c734

ENV           GOLANG_VERSION 1.17.11
ENV           GOLANG_LINUX_AMD64_SHA512 f25e730abc94364ae36c5d5834125cec1cea77c0c8a65ec23acf6f2c3f0a8e908547530202f818d13b74f21a037206fed546826838ffdebc5d1a10cb3a182e44
ENV           GOLANG_LINUX_ARM64_SHA512 bef59fc7fccc7570ab8222af41af852354b7b926f41f48377c3bcd891dd4fc312ca82d4b2c8fe9b669b37d5cb385dbdaf58a92af3b89991e825dc6cafc793d03
ENV           GOLANG_LINUX_ARM_V7_SHA512 2812c3d6596709cb99c5da809c19b51c2601901fb70e48486e9ae1d201eb03878b36aa575849641e4b91addbcbf843ca27ccab150031a9c82c35681291c69859
ENV           GOLANG_LINUX_ARM_V6_SHA512 2812c3d6596709cb99c5da809c19b51c2601901fb70e48486e9ae1d201eb03878b36aa575849641e4b91addbcbf843ca27ccab150031a9c82c35681291c69859
ENV           GOLANG_LINUX_386_SHA512 ab42e96650b33bf9612230b3a145873a2536bd54a6c0d8ec990b543c7abe6b3d96a232b398c752437e0fa6b4952a4f74b2106ae8f774b3b02f2266fcd34231bf
ENV           GOLANG_LINUX_S390X_SHA512 642ac391a119fbfa0133c93825f3e2bf6fe57d562f9d77557d5dec2749e7474bdb41e5688957a3a6b83dd67866ccbfa4c90874aba7d6c35623f49570a6756127
ENV           GOLANG_LINUX_PPC64LE_SHA512 7125f3be057109b9be52ae3b417004a72183385b03818194d17ea4e2f3522df2d12f56bb9fa2593eccf724b65dac34b5c4ac08d235699b3e407178aaf7247a07

ENV           FAIL_WHEN_OUTDATED=true

# hadolint ignore=DL3009
RUN           --mount=type=secret,uid=100,id=CA \
              --mount=type=secret,uid=100,id=CERTIFICATE \
              --mount=type=secret,uid=100,id=KEY \
              --mount=type=secret,uid=100,id=GPG.gpg \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=APT_SOURCES \
              --mount=type=secret,id=APT_CONFIG \
              apt-get update -qq; \
              apt-cache show curl gnupg dirmngr ca-certificates; \
              apt-get install -qq --no-install-recommends \
                curl=7.74.0-1.3+deb11u1 \
                gnupg=2.2.27-2+deb11u1 \
                dirmngr=2.2.27-2+deb11u1 \
                ca-certificates=20210119

COPY          ./scripts /scripts

COPY          ./cache /cache

# Helper for our secrets
ENV           CURL_HOME=/run/secrets

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh node

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh yarn

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh golang

RUN           epoch="$(date --date "$BUILD_CREATED" +%s)"; \
              find /cache -newermt "@$epoch" -exec touch --no-dereference --date="@$epoch" '{}' +

FROM          scratch                                                                                                   AS downloader

COPY          --from=downloader-builder /cache /cache
