ARG           BUILDER_BASE=docker.io/dubodubonduponey/debian@sha256:05ff8e388e27caddcc2eb07056aaec33af736ba8639939081feeace936df4d54

#######################
# Downloader is here only to retrieve and validate upstream tarballs
#######################
# hadolint ignore=DL3006
FROM          $BUILDER_BASE                                                                                             AS downloader-builder

ARG           BUILD_CREATED="1976-04-14T17:00:00-07:00"

ARG           DEBIAN_FRONTEND="noninteractive"
ENV           TERM="xterm"
ENV           LANG="C.UTF-8"
ENV           LC_ALL="C.UTF-8"
ENV           TZ="America/Los_Angeles"

ENV           NODE_VERSION 10.22.1
ENV           YARN_VERSION 1.22.5

ENV           GOLANG_VERSION 1.15.2

ENV           GOLANG_LINUX_AMD64_SHA512 99843f75f95d5e3e7999c14860204005f34d545cbe5e20e96288ed857e4401fab6fe263d11af74a2d11ecccfe62d7a8acbbf3e19c34954a0fc3c6e63dc8341b6
ENV           GOLANG_LINUX_ARM64_SHA512 4e032a6d29b5dd013e81ae2ee6cea38ad17971c7b472c12bc2b792a1aef2f5543419f1069a15efb3a3c14cd732021f366c59e87933d68719c6dedc5519a2abdc
ENV           GOLANG_LINUX_ARM_V7_SHA512 c0d415e55e154c0151614d30f6462ba8cb2f285fd99659d7e20fbbbd846e08d0335a4a03ae6a9fa4d3bb6e04b303250f1a645cd8d11814389edcdd9da830afee
ENV           GOLANG_LINUX_ARM_V6_SHA512 c0d415e55e154c0151614d30f6462ba8cb2f285fd99659d7e20fbbbd846e08d0335a4a03ae6a9fa4d3bb6e04b303250f1a645cd8d11814389edcdd9da830afee
ENV           GOLANG_LINUX_386_SHA512 84935b8be9acc940a7d4f65202d5f7de45c3e424158b4bd851994f6deb58973c8853ee8ae447c00454b1029b5da1203d3b8cc77ed976cf08c9193aaed0e6ff3b
ENV           GOLANG_LINUX_S390X_SHA512 49c3e0ea1bf66c6d5c1595af76198ea59bf47346f04002200a6a6f6803b5d5ac2d5bc28548160499a0782eb112fe7e2105684c5c15cb26e4177177108579d65f
ENV           GOLANG_LINUX_PPC64LE_SHA512 661403501f3d12e2206af229755c2c1fc1b0b3ce35a1b63521ce82bd8bd58ea897786f1ede8fdba47021085f6357a9a85443578134ef59d4c745a4c0e71da403

ENV           FAIL_WHEN_OUTDATED true

# hadolint ignore=DL3009
RUN           set -eu; \
              apt-get update -qq && \
              apt-get install -qq --no-install-recommends \
                curl=7.64.0-4+deb10u1 \
                gnupg=2.2.12-1+deb10u1 \
                dirmngr=2.2.12-1+deb10u1 \
                ca-certificates=20200601~deb10u1

RUN           update-ca-certificates

COPY          ./scripts /scripts

COPY          ./cache /cache

RUN           /scripts/entrypoint.sh

RUN           epoch="$(date --date "$BUILD_CREATED" +%s)"; \
              find /cache -newermt "@$epoch" -exec touch --no-dereference --date="@$epoch" '{}' +

FROM          scratch                                                                                                   AS downloader

COPY          --from=downloader-builder /cache /cache
