ARG           BUILDER_BASE=docker.io/dubodubonduponey/debian@sha256:6afd5f2d61c05210227a06521442567937334b3f5b1e7546abd588000a62fd44

#######################
# Downloader is here only to retrieve and validate upstream tarballs
#######################
# hadolint ignore=DL3006
FROM          $BUILDER_BASE                                                                                             AS downloader-builder

ARG           BUILD_CREATED="1976-04-14T17:00:00-07:00"

ARG           DEBIAN_FRONTEND="noninteractive"
ENV           TERM="xterm"
ENV           LANG="C.UTF-8"
ENV           LC_ALL="C.UTF-8"
ENV           TZ="America/Los_Angeles"

ENV           NODE_VERSION 10.22.0
ENV           YARN_VERSION 1.22.5

ENV           GOLANG_VERSION 1.15.1

ENV           GOLANG_LINUX_AMD64_SHA512 5d73405368a48aa7e6409092fcbe7ebb15abcca8d8e1dc862ff6824b84367d88d50bb6e3654340f20d72d76da81c18af2bee1e5655a6d60f73718ee74bab17c2
ENV           GOLANG_LINUX_ARM64_SHA512 bb7e3e963b70d500e9d74139aef08562ec57c55d1bbe6b0d438203d03c2a3d11a27b66cdef61f370cd90163814c9bd3baabf6f7eaaa99047a5f0bfbe512375c3
ENV           GOLANG_LINUX_ARM_V7_SHA512 65296387c0ede218585e813704167d1f67350b35c41ed4abf730499c20db9fd06b936842722cbe823cf6619f85b9fcf8d678a8709249469973310cb41a05529e
ENV           GOLANG_LINUX_ARM_V6_SHA512 65296387c0ede218585e813704167d1f67350b35c41ed4abf730499c20db9fd06b936842722cbe823cf6619f85b9fcf8d678a8709249469973310cb41a05529e
ENV           GOLANG_LINUX_386_SHA512 abe57445e85ffdaaaff74fdbcce04fe0a5539a922e1180805a6ab2358a028052a3ff1ae39297524e5efd47d2a3b6512f7e3acd1f2f9bffe235e08ad00fa8e5fb
ENV           GOLANG_LINUX_S390X_SHA512 aa1b954c5b44084ea4f5fee6d531914e5a3aca473bd96629fd405e832971543d1d31cbc20e2e05210fdaf0ba0cdea791f03ee3703b178146a6c1b38d9c2ac4a3
ENV           GOLANG_LINUX_PPC64LE_SHA512 a7f111c75544c119cbce6a0b1e8bf513e678693681c19987de2087754d6a846b0b56bfde72e2edbb37a093fe6a717b29600754710320b0788541afcab6b5d3e2

ENV           FAIL_WHEN_OUTDATED true

# hadolint ignore=DL3009
RUN           set -eu; \
              apt-get update -qq && \
              apt-get install -qq --no-install-recommends \
                curl=7.64.0-4+deb10u1 \
                gnupg=2.2.12-1+deb10u1 \
                dirmngr=2.2.12-1+deb10u1 \
                ca-certificates=20200601~deb10u1

RUN           update-ca-certificates

COPY          ./scripts /scripts

COPY          ./cache /cache

RUN           /scripts/entrypoint.sh

RUN           epoch="$(date --date "$BUILD_CREATED" +%s)"; \
              find /cache -newermt "@$epoch" -exec touch --no-dereference --date="@$epoch" '{}' +

FROM          scratch                                                                                                   AS downloader

COPY          --from=downloader-builder /cache /cache
