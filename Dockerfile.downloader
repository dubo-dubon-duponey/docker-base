ARG           FROM_IMAGE=ghcr.io/dubo-dubon-duponey/debian:bullseye-2021-07-01@sha256:d162e34b3a53944cec3ba525b07ef6152ff391ed916de4ee4eb04debb019c8b0
#######################
# Downloader is here only to retrieve and validate upstream tarballs
#######################
FROM          $FROM_IMAGE                                                                                       AS downloader-builder

ARG           BUILD_CREATED="1976-04-14T17:00:00-07:00"

ENV           NODE_VERSION=14.17.2
ENV           YARN_VERSION=1.22.5

ENV           GOLANG_VERSION 1.16.5
ENV           GOLANG_LINUX_AMD64_SHA512 dcc9d0c3ac7ae6ce17e9f6a4bbecaf035c778e42a68a2b4e48ac38ac44f748cfbbe5aa4e0689caf0ddc3d45fe2a5a16cf1226844101344910462fcdd0f19570d
ENV           GOLANG_LINUX_ARM64_SHA512 da399301416dba1b98c3d62d52bf05cf99ffeb2c224410fd37ddc3cb488be862496337d979b367203e30429e6295f45a7eb392b4992e1af4b127128e55c69f17
ENV           GOLANG_LINUX_ARM_V7_SHA512 d54a22b3b8ed2a54e87778575056d5e093f307f834d9b24d261fbbcdd60d56e1858565895fd125fc6eef0c4dfb53fe25f1f396723fe44fa936ebf8c33bd6703c
ENV           GOLANG_LINUX_ARM_V6_SHA512 d54a22b3b8ed2a54e87778575056d5e093f307f834d9b24d261fbbcdd60d56e1858565895fd125fc6eef0c4dfb53fe25f1f396723fe44fa936ebf8c33bd6703c
ENV           GOLANG_LINUX_386_SHA512 747dfc09b26387b6575a6698047825a029e8fcfd1504aa458fe57306f798668c4b2a6967a06c2a7a5a7705e397b020f9e3e7f18e0322cf42aac27cc617bd1649
ENV           GOLANG_LINUX_S390X_SHA512 2ec1c9e4c402e3c8383d787108814ebcdd3b9edee52f5969db4f4066db9010a1a593661ef9c8bd89212d81f8875ea32e3523a352a16c3b886106e61f84f597d8
ENV           GOLANG_LINUX_PPC64LE_SHA512 7c02b0a2ee565a45e60aa49cc629a8b5d0dabe677b5d56fca05b9fa208dcee18d5747403f628c43b6d1b1d229f0df1dcb10bae20a6c067dbb004338f7ea5c89b

ENV           GOLANG_OLD_VERSION 1.15.13
ENV           GOLANG_OLD_LINUX_AMD64_SHA512 866aa22f9ecdba3c250f206d71ced5857aee67bf8da470b68447c11488dc80e243e985c9baeedf56476ddc113320bf0ed5efe8453bd3da071c4aa3abb58e142d
ENV           GOLANG_OLD_LINUX_ARM64_SHA512 362499cd4640bd7a9a7358afbcdd89783c0af5ac2a2209a37e8f15dc2e1392fa1d4704ec33cdf28fa00c09a13b36568e639634b8fa89b958ee7fa9237f1f3e93
ENV           GOLANG_OLD_LINUX_ARM_V7_SHA512 26eff19aeef922554f6582767488182bf16e3278e0c124f6d0c6524db441465b6c1432976c4c6e88b84a2aab385280e1dd374428c2ac0070806593e108f2ad54
ENV           GOLANG_OLD_LINUX_ARM_V6_SHA512 26eff19aeef922554f6582767488182bf16e3278e0c124f6d0c6524db441465b6c1432976c4c6e88b84a2aab385280e1dd374428c2ac0070806593e108f2ad54
ENV           GOLANG_OLD_LINUX_386_SHA512 6c92732fb2ce75b084cb925e9813d45d626cae8193a1fa4a8f057e65bef1ff6bb64ac68d417dedae51ebae1182b54fb9365ac82dcc42751b2fc697aad015625a
ENV           GOLANG_OLD_LINUX_S390X_SHA512 0739486667d6a9ea9514dce309afb28a38505ae49337fc3223dcff038685858afbe1f507b6d4d4b89872874e01d01ceac7f0f814f439fbdf4734a212188ee4c9
ENV           GOLANG_OLD_LINUX_PPC64LE_SHA512 c8a7de65d4f633ee7c058070c6ebd01c3ebcfc9119e2371d18bb775b72b1961c705579df59c69c781eba29b0bbec901080c296ea568a12b610f70c65e2109cf4

ENV           FAIL_WHEN_OUTDATED=true

# hadolint ignore=DL3009
RUN           --mount=type=secret,uid=100,id=CA \
              --mount=type=secret,uid=100,id=CERTIFICATE \
              --mount=type=secret,uid=100,id=KEY \
              --mount=type=secret,uid=100,id=GPG.gpg \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=APT_SOURCES \
              --mount=type=secret,id=APT_CONFIG \
              apt-get update -qq; \
              apt-cache show curl gnupg dirmngr ca-certificates; \
              apt-get install -qq --no-install-recommends \
                curl=7.74.0-1.2 \
                gnupg=2.2.27-2 \
                dirmngr=2.2.27-2 \
                ca-certificates=20210119

COPY          ./scripts /scripts

COPY          ./cache /cache

# Helper for our secrets
ENV           CURL_HOME=/run/secrets

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh node

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh yarn

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh golang

RUN           --mount=type=secret,id=CA \
              --mount=type=secret,id=CERTIFICATE \
              --mount=type=secret,id=KEY \
              --mount=type=secret,id=NETRC \
              --mount=type=secret,id=.curlrc \
              /scripts/entrypoint.sh golang_old

RUN           epoch="$(date --date "$BUILD_CREATED" +%s)"; \
              find /cache -newermt "@$epoch" -exec touch --no-dereference --date="@$epoch" '{}' +

FROM          scratch                                                                                                   AS downloader

COPY          --from=downloader-builder /cache /cache
